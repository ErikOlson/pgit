#!/bin/sh
# pgit â€” git multiplexer for process & product separation
# POSIX sh, no bashisms

set -e

PGIT_VERSION="0.3.0"
PGIT_REGISTRY_DIR="${XDG_CONFIG_HOME:-$HOME/.config}/pgit/patterns"

# Resolve lib directory relative to this script
PGIT_LIB="$(cd "$(dirname "$0")/../lib" && pwd)"

. "$PGIT_LIB/pgit-core.sh"
. "$PGIT_LIB/pgit-patterns.sh"
. "$PGIT_LIB/pgit-registry.sh"
. "$PGIT_LIB/pgit-config.sh"
. "$PGIT_LIB/pgit-init.sh"
. "$PGIT_LIB/pgit-add.sh"
. "$PGIT_LIB/pgit-commit.sh"
. "$PGIT_LIB/pgit-pp.sh"

# --- Main dispatch ---

case "${1:-}" in
    --version|-V)
        echo "pgit $PGIT_VERSION"
        exit 0
        ;;
    --help|-h)
        echo "usage: pgit [--version] [-p] <git-command> [<args>]"
        echo "       pgit init"
        echo "       pgit adopt [-y]"
        echo "       pgit add-to-process <file> [<file> ...]"
        echo "       pgit pp <command>"
        echo "       pgit completions <shell>"
        echo ""
        echo "Git multiplexer for process & product separation."
        echo ""
        echo "  pgit <cmd>             Run git against the product repo"
        echo "  pgit -p <cmd>          Run git against the process repo"
        echo "  pgit pp <cmd>          P&P multiplexer commands"
        echo "  pgit init              Initialize pgit in current directory"
        echo "  pgit adopt [-y]        Adopt pgit in an existing repo"
        echo "  pgit add-to-process    Move file(s) from product to process"
        echo "  pgit completions       Print shell completion script"
        exit 0
        ;;
esac

# Commands that don't need .pgit/
if [ "${1:-}" = "completions" ]; then
    _shell="${2:-}"
    _completions_dir="$(cd "$(dirname "$0")/../completions" && pwd)"
    case "$_shell" in
        bash) cat "$_completions_dir/pgit.bash" ;;
        zsh)  cat "$_completions_dir/_pgit" ;;
        fish) cat "$_completions_dir/pgit.fish" ;;
        *)
            echo "usage: pgit completions <bash|zsh|fish>" >&2
            exit 1
            ;;
    esac
    exit 0
fi

if [ "${1:-}" = "init" ]; then
    shift
    pgit_init "$@"
    exit 0
fi

if [ "${1:-}" = "adopt" ]; then
    shift
    pgit_adopt "$@"
    exit 0
fi

# pp registry works without .pgit/
if [ "${1:-}" = "pp" ] && [ "${2:-}" = "registry" ]; then
    shift 2
    pgit_pp_registry "$@"
    exit 0
fi

# Commands that require .pgit/
case "${1:-}" in
    -p|pp)
        if ! pgit_find_root; then
            pgit_die "not a pgit directory (no .pgit/ found)."
        fi
        case "$1" in
            -p)
                shift
                if [ $# -eq 0 ]; then
                    pgit_process_git status
                else
                    pgit_process_git "$@"
                fi
                ;;
            pp)
                shift
                pgit_pp "$@"
                ;;
        esac
        ;;
    *)
        if pgit_find_root; then
            case "$1" in
                add)
                    shift
                    pgit_add "$@"
                    ;;
                commit)
                    shift
                    pgit_commit "$@"
                    ;;
                add-to-process)
                    shift
                    pgit_add_to_process "$@"
                    ;;
                config)
                    case "${2:-}" in
                        pp.*)
                            shift
                            pgit_config_cmd "$@"
                            ;;
                        *)
                            pgit_product_git "$@"
                            ;;
                    esac
                    ;;
                *)
                    pgit_product_git "$@"
                    ;;
            esac
        else
            exec git "$@"
        fi
        ;;
esac
